{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white tracking-tight">System Status & Port Monitor</h1>
        <p class="mt-2 text-gray-400">Real-time system metrics and active port usage</p>
    </div>

    <!-- System Resources -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- CPU Usage -->
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-400">CPU Usage</h3>
                <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                </svg>
            </div>
            <div class="flex items-baseline">
                <p class="text-3xl font-bold text-white">{{ "%.1f"|format(system_info.cpu_percent) }}%</p>
                <p class="ml-2 text-sm text-gray-500">{{ system_info.cpu_count }} cores</p>
            </div>
            <div class="mt-3 w-full bg-gray-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all" 
                     style="width: {{ system_info.cpu_percent }}%"></div>
            </div>
        </div>

        <!-- Memory Usage -->
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-400">Memory</h3>
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
            </div>
            <div class="flex items-baseline">
                <p class="text-3xl font-bold text-white">{{ "%.1f"|format(system_info.memory_percent) }}%</p>
                <p class="ml-2 text-sm text-gray-500">{{ "%.1f"|format(system_info.memory_used / 1024**3) }} GB</p>
            </div>
            <div class="mt-3 w-full bg-gray-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-2 rounded-full transition-all" 
                     style="width: {{ system_info.memory_percent }}%"></div>
            </div>
            <p class="mt-2 text-xs text-gray-500">Total: {{ "%.1f"|format(system_info.memory_total / 1024**3) }} GB</p>
        </div>

        <!-- Disk Usage -->
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-400">Disk Space</h3>
                <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                </svg>
            </div>
            <div class="flex items-baseline">
                <p class="text-3xl font-bold text-white">{{ "%.1f"|format(system_info.disk_percent) }}%</p>
                <p class="ml-2 text-sm text-gray-500">{{ "%.1f"|format(system_info.disk_used / 1024**3) }} GB</p>
            </div>
            <div class="mt-3 w-full bg-gray-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-2 rounded-full transition-all" 
                     style="width: {{ system_info.disk_percent }}%"></div>
            </div>
            <p class="mt-2 text-xs text-gray-500">Total: {{ "%.1f"|format(system_info.disk_total / 1024**3) }} GB</p>
        </div>

        <!-- Uptime -->
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-400">System Uptime</h3>
                <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="flex items-baseline">
                <p class="text-2xl font-bold text-white">{{ system_info.uptime }}</p>
            </div>
            <p class="mt-4 text-sm text-gray-500">Running smoothly</p>
        </div>
    </div>

    <!-- Active Ports -->
    <div class="glass-card rounded-2xl overflow-hidden shadow-xl mb-8">
        <div class="p-6 border-b border-gray-700/50">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-white">Active Listening Ports</h2>
                    <p class="text-sm text-gray-400 mt-1">All ports currently accepting connections</p>
                </div>
                <span class="px-4 py-2 bg-indigo-500/20 text-indigo-300 rounded-lg font-medium">
                    {{ listening_ports|length }} Ports Active
                </span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-800/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Port</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Project</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Process</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">PID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Command</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700/50">
                    {% for port in listening_ports %}
                    <tr class="hover:bg-gray-800/30 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                                {% if port.project %}bg-indigo-500/20 text-indigo-300{% else %}bg-gray-700 text-gray-300{% endif %}">
                                :{{ port.port }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if port.project %}
                                <span class="text-white font-medium">{{ port.project }}</span>
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-gray-300">{{ port.process }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-gray-400 font-mono text-sm">{{ port.pid }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-gray-400 text-sm truncate block max-w-md" title="{{ port.cmdline }}">
                                {{ port.cmdline[:80] }}{% if port.cmdline|length > 80 %}...{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if port.pid != 'N/A' %}
                            <form method="POST" action="{{ url_for('main.kill_process', pid=port.pid) }}" style="display:inline;"
                                  onsubmit="return confirm('Are you sure you want to kill process {{ port.process }} (PID: {{ port.pid }})?');">
                                <button type="submit" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm font-medium transition-colors">
                                    Kill
                                </button>
                            </form>
                            {% else %}
                            <span class="text-gray-600 text-sm">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Projects Overview -->
    <div class="glass-card rounded-2xl overflow-hidden shadow-xl">
        <div class="p-6 border-b border-gray-700/50">
            <h2 class="text-xl font-bold text-white">Registered Projects</h2>
            <p class="text-sm text-gray-400 mt-1">All projects configured in VDS Panel</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-800/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Project Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Port</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Domain</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700/50">
                    {% for project in projects %}
                    <tr class="hover:bg-gray-800/30 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="{{ url_for('main.project_details', id=project.id) }}" 
                               class="text-indigo-400 hover:text-indigo-300 font-medium">
                                {{ project.name }}
                            </a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 rounded-full text-sm font-medium bg-gray-700 text-gray-300">
                                :{{ project.port }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if project.status == 'running' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500/20 text-green-400">
                                    <span class="w-2 h-2 mr-1.5 rounded-full bg-green-400 animate-pulse"></span>
                                    Running
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-gray-400">
                                    <span class="w-2 h-2 mr-1.5 rounded-full bg-gray-500"></span>
                                    Stopped
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-gray-300 text-sm">{{ project.project_type|title }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if project.domain %}
                                <span class="text-gray-300">{{ project.domain }}</span>
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- System Services Manager -->
    <div class="glass-card rounded-2xl overflow-hidden shadow-xl mt-8">
        <div class="p-6 border-b border-gray-700/50">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-white">Systemd Services</h2>
                    <p class="text-sm text-gray-400 mt-1">Manage system services</p>
                </div>
                <button id="refreshServices" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-medium transition-colors">
                    Refresh
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <input type="text" id="serviceFilter" placeholder="Filter services..." 
                    class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
            </div>
            <div id="servicesContainer" class="overflow-x-auto">
                <div class="text-center text-gray-400 py-8">Loading services...</div>
            </div>
        </div>
    </div>

    <!-- System Logs Viewer -->
    <div class="glass-card rounded-2xl overflow-hidden shadow-xl mt-8">
        <div class="p-6 border-b border-gray-700/50">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-white">System Logs</h2>
                    <p class="text-sm text-gray-400 mt-1">View system and service logs</p>
                </div>
                <div class="flex gap-2">
                    <select id="logType" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500">
                        <option value="syslog">Syslog</option>
                        <option value="auth">Auth Log</option>
                        <option value="nginx-access">Nginx Access</option>
                        <option value="nginx-error">Nginx Error</option>
                    </select>
                    <button id="refreshLogs" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-medium transition-colors">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="p-6">
            <div id="logsContainer" class="bg-gray-900 rounded-lg p-4 font-mono text-xs text-green-400 h-96 overflow-y-auto">
                <div class="text-gray-500">Select a log type and click Refresh</div>
            </div>
        </div>
    </div>

    <!-- File Browser -->
    <div class="glass-card rounded-2xl overflow-hidden shadow-xl mt-8">
        <div class="p-6 border-b border-gray-700/50">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-white">File Browser</h2>
                    <p class="text-sm text-gray-400 mt-1">Browse server files (limited to safe paths)</p>
                </div>
                <div id="currentPath" class="text-sm text-gray-400 font-mono">/opt/vdspanel</div>
            </div>
        </div>
        <div class="p-6">
            <div class="mb-4 flex gap-2">
                <button onclick="browsePath('/opt/vdspanel')" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors">
                    VDS Panel
                </button>
                <button onclick="browsePath('/var/log')" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors">
                    Logs
                </button>
                <button onclick="browsePath('/etc/nginx')" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors">
                    Nginx Config
                </button>
            </div>
            <div id="fileBrowserContainer" class="overflow-x-auto">
                <div class="text-center text-gray-400 py-8">Click a quick path above to start browsing</div>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div id="fileViewerModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-700 flex items-center justify-between">
                <h3 id="fileViewerTitle" class="text-xl font-bold text-white"></h3>
                <button onclick="closeFileViewer()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <pre id="fileContent" class="bg-gray-900 rounded-lg p-4 text-sm text-gray-300 font-mono overflow-x-auto"></pre>
            </div>
        </div>
    </div>

    <!-- Service Logs Modal -->
    <div id="serviceLogsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-700 flex items-center justify-between">
                <h3 id="serviceLogsTitle" class="text-xl font-bold text-white"></h3>
                <button onclick="closeServiceLogs()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <pre id="serviceLogs" class="bg-gray-900 rounded-lg p-4 text-sm text-green-400 font-mono overflow-x-auto"></pre>
            </div>
        </div>
    </div>
</div>

<script>
// Load services on page load
document.addEventListener('DOMContentLoaded', function() {
    loadServices();
});

// Refresh services button
document.getElementById('refreshServices').addEventListener('click', loadServices);

// Load systemd services
async function loadServices() {
    const container = document.getElementById('servicesContainer');
    container.innerHTML = '<div class="text-center text-gray-400 py-8">Loading services...</div>';
    
    try {
        const response = await fetch('/api/services');
        const data = await response.json();
        
        if (data.success) {
            renderServices(data.services);
        } else {
            container.innerHTML = `<div class="text-center text-red-400 py-8">Error: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="text-center text-red-400 py-8">Error: ${error.message}</div>`;
    }
}

// Render services table
function renderServices(services) {
    const container = document.getElementById('servicesContainer');
    
    if (services.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8">No services found</div>';
        return;
    }
    
    let html = `
        <table class="w-full">
            <thead class="bg-gray-800/50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Service</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">State</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700/50">
    `;
    
    services.forEach(service => {
        const statusColor = service.active === 'active' ? 'green' : service.active === 'failed' ? 'red' : 'gray';
        html += `
            <tr class="service-row hover:bg-gray-800/30 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-white font-medium">${service.name}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-500/20 text-${statusColor}-400">
                        ${service.active}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-gray-400 text-sm">${service.sub}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="text-gray-400 text-sm">${service.description}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex gap-2">
                        ${service.active === 'active' ? 
                            `<form method="POST" action="/service-control/stop/${service.name}" style="display:inline;" onsubmit="return confirm('Stop ${service.name}?');">
                                <button type="submit" class="px-2 py-1 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded text-xs font-medium transition-colors">
                                    Stop
                                </button>
                            </form>
                            <form method="POST" action="/service-control/restart/${service.name}" style="display:inline;">
                                <button type="submit" class="px-2 py-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded text-xs font-medium transition-colors">
                                    Restart
                                </button>
                            </form>` :
                            `<form method="POST" action="/service-control/start/${service.name}" style="display:inline;">
                                <button type="submit" class="px-2 py-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded text-xs font-medium transition-colors">
                                    Start
                                </button>
                            </form>`
                        }
                        <button onclick="viewServiceLogs('${service.name}')" class="px-2 py-1 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-400 rounded text-xs font-medium transition-colors">
                            Logs
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Filter services
document.getElementById('serviceFilter').addEventListener('input', function(e) {
    const filter = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.service-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});

// Load logs
document.getElementById('refreshLogs').addEventListener('click', async function() {
    const logType = document.getElementById('logType').value;
    const container = document.getElementById('logsContainer');
    
    container.innerHTML = '<div class="text-gray-500">Loading logs...</div>';
    
    try {
        const response = await fetch(`/api/system-logs?type=${logType}&lines=100`);
        const data = await response.json();
        
        if (data.success) {
            container.textContent = data.logs || '(no logs)';
        } else {
            container.innerHTML = `<div class="text-red-400">Error: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="text-red-400">Error: ${error.message}</div>`;
    }
    
    container.scrollTop = container.scrollHeight;
});

// Browse files
async function browsePath(path) {
    const container = document.getElementById('fileBrowserContainer');
    const pathDisplay = document.getElementById('currentPath');
    
    container.innerHTML = '<div class="text-center text-gray-400 py-8">Loading...</div>';
    pathDisplay.textContent = path;
    
    try {
        const response = await fetch(`/api/file-browser?path=${encodeURIComponent(path)}`);
        const data = await response.json();
        
        if (data.success) {
            renderFileBrowser(data);
        } else {
            container.innerHTML = `<div class="text-center text-red-400 py-8">Error: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="text-center text-red-400 py-8">Error: ${error.message}</div>`;
    }
}

// Render file browser
function renderFileBrowser(data) {
    const container = document.getElementById('fileBrowserContainer');
    
    let html = '<div class="space-y-1">';
    
    // Parent directory
    if (data.parent) {
        html += `
            <div onclick="browsePath('${data.parent}')" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-800 rounded-lg cursor-pointer transition-colors">
                <span class="text-xl">üìÅ</span>
                <span class="text-indigo-400 font-medium">..</span>
            </div>
        `;
    }
    
    // Directories first
    data.items.filter(item => item.is_dir).forEach(item => {
        html += `
            <div onclick="browsePath('${item.path}')" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-800 rounded-lg cursor-pointer transition-colors">
                <span class="text-xl">üìÅ</span>
                <span class="text-white font-medium flex-1">${item.name}</span>
            </div>
        `;
    });
    
    // Files
    data.items.filter(item => !item.is_dir).forEach(item => {
        const size = formatFileSize(item.size);
        html += `
            <div onclick="viewFile('${item.path}')" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-800 rounded-lg cursor-pointer transition-colors">
                <span class="text-xl">üìÑ</span>
                <span class="text-gray-300 flex-1">${item.name}</span>
                <span class="text-gray-500 text-sm">${size}</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// View file content
async function viewFile(filepath) {
    const modal = document.getElementById('fileViewerModal');
    const title = document.getElementById('fileViewerTitle');
    const content = document.getElementById('fileContent');
    
    title.textContent = filepath;
    content.textContent = 'Loading...';
    modal.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/file-content?path=${encodeURIComponent(filepath)}`);
        const data = await response.json();
        
        if (data.success) {
            content.textContent = data.content;
        } else {
            content.textContent = `Error: ${data.error}`;
        }
    } catch (error) {
        content.textContent = `Error: ${error.message}`;
    }
}

function closeFileViewer() {
    document.getElementById('fileViewerModal').classList.add('hidden');
}

// View service logs
async function viewServiceLogs(serviceName) {
    const modal = document.getElementById('serviceLogsModal');
    const title = document.getElementById('serviceLogsTitle');
    const logs = document.getElementById('serviceLogs');
    
    title.textContent = `${serviceName} - Logs`;
    logs.textContent = 'Loading logs...';
    modal.classList.remove('hidden');
    
    try {
        const response = await fetch(`/api/service-logs/${serviceName}`);
        const data = await response.json();
        
        if (data.success) {
            logs.textContent = data.logs || '(no logs)';
        } else {
            logs.textContent = `Error: ${data.error}`;
        }
    } catch (error) {
        logs.textContent = `Error: ${error.message}`;
    }
}

function closeServiceLogs() {
    document.getElementById('serviceLogsModal').classList.add('hidden');
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Auto-refresh every 30 seconds (disabled for now to avoid interrupting service management)
// setTimeout(function() {
//     location.reload();
// }, 30000);
</script>
{% endblock %}
