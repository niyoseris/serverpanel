{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white tracking-tight">Web Terminal</h1>
        <p class="mt-2 text-gray-400">Execute commands directly on the server</p>
    </div>

    <!-- Terminal Container -->
    <div class="glass-card rounded-2xl overflow-hidden shadow-xl">
        <div class="bg-gray-800/80 px-6 py-3 border-b border-gray-700/50 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="ml-4 text-sm text-gray-400 font-mono">root@vds-panel:~$</span>
            </div>
            <button id="clearTerminal" class="text-sm text-gray-400 hover:text-white transition-colors">
                Clear
            </button>
        </div>
        
        <!-- Terminal Output -->
        <div id="terminalOutput" class="bg-gray-900 p-6 font-mono text-sm text-green-400 h-96 overflow-y-auto whitespace-pre-wrap break-words">
            <div class="text-gray-500">Welcome to VDS Panel Web Terminal</div>
            <div class="text-gray-500">Type your commands below...</div>
            <div class="mt-2"></div>
        </div>
        
        <!-- Command Input -->
        <div class="bg-gray-800/80 px-6 py-4 border-t border-gray-700/50">
            <form id="commandForm" class="flex gap-3 items-start">
                <span class="text-green-400 font-mono flex-shrink-0 mt-2">$</span>
                <textarea 
                    id="commandInput" 
                    autocomplete="off"
                    placeholder="Enter command... (Shift+Enter for new line, Enter to execute)"
                    rows="1"
                    class="flex-1 bg-transparent border-none outline-none text-white font-mono placeholder-gray-600 resize-none overflow-hidden min-h-[36px]"
                ></textarea>
                <button 
                    type="submit" 
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-medium transition-colors">
                    Execute
                </button>
            </form>
        </div>
    </div>

    <!-- Quick Commands -->
    <div class="mt-6 glass-card rounded-2xl p-6">
        <h3 class="text-lg font-bold text-white mb-4">Quick Commands</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button onclick="runQuickCommand('df -h')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">Disk Usage</div>
                <div class="text-xs text-gray-500">df -h</div>
            </button>
            <button onclick="runQuickCommand('free -h')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">Memory Usage</div>
                <div class="text-xs text-gray-500">free -h</div>
            </button>
            <button onclick="runQuickCommand('top -bn1 | head -20')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">Top Processes</div>
                <div class="text-xs text-gray-500">top -bn1</div>
            </button>
            <button onclick="runQuickCommand('systemctl list-units --type=service --state=running')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">Running Services</div>
                <div class="text-xs text-gray-500">systemctl list-units</div>
            </button>
            <button onclick="runQuickCommand('netstat -tulpn')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">Network Ports</div>
                <div class="text-xs text-gray-500">netstat -tulpn</div>
            </button>
            <button onclick="runQuickCommand('ps aux --sort=-%mem | head -10')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">Memory Hogs</div>
                <div class="text-xs text-gray-500">ps aux</div>
            </button>
            <button onclick="runQuickCommand('docker ps')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">Docker Containers</div>
                <div class="text-xs text-gray-500">docker ps</div>
            </button>
            <button onclick="runQuickCommand('uptime')" class="px-4 py-2 bg-gray-800/50 hover:bg-gray-700 rounded-lg text-sm text-gray-300 transition-colors text-left">
                <div class="font-medium">System Uptime</div>
                <div class="text-xs text-gray-500">uptime</div>
            </button>
        </div>
    </div>

    <!-- Command History -->
    <div class="mt-6 glass-card rounded-2xl p-6">
        <h3 class="text-lg font-bold text-white mb-4">Command History</h3>
        <div id="commandHistory" class="space-y-2 font-mono text-sm">
            <div class="text-gray-500 text-xs">No commands executed yet</div>
        </div>
    </div>
</div>

<script>
const commandForm = document.getElementById('commandForm');
const commandInput = document.getElementById('commandInput');
const terminalOutput = document.getElementById('terminalOutput');
const clearBtn = document.getElementById('clearTerminal');
const historyContainer = document.getElementById('commandHistory');

let commandHistory = [];
let historyIndex = -1;

// Handle form submission
commandForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const command = commandInput.value.trim();
    
    if (!command) return;
    
    // Add to history
    commandHistory.push(command);
    historyIndex = commandHistory.length;
    updateHistory();
    
    // Display command in terminal
    addToTerminal(`<span class="text-blue-400">$ ${escapeHtml(command)}</span>`);
    
    // Clear input
    commandInput.value = '';
    
    // Execute command
    try {
        const formData = new FormData();
        formData.append('command', command);
        
        const response = await fetch('{{ url_for("main.execute_command") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.output) {
                addToTerminal(`<span class="text-white">${escapeHtmlPreserveNewlines(result.output)}</span>`);
            }
            if (result.error) {
                addToTerminal(`<span class="text-red-400">${escapeHtmlPreserveNewlines(result.error)}</span>`);
            }
            if (!result.output && !result.error) {
                addToTerminal(`<span class="text-gray-500">(no output)</span>`);
            }
        } else {
            addToTerminal(`<span class="text-red-400">Error: ${escapeHtml(result.error)}</span>`);
        }
    } catch (error) {
        addToTerminal(`<span class="text-red-400">Error: ${escapeHtml(error.message)}</span>`);
    }
    
    addToTerminal('');
});

// Quick command execution
function runQuickCommand(command) {
    commandInput.value = command;
    commandForm.dispatchEvent(new Event('submit'));
}

// Add text to terminal
function addToTerminal(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    terminalOutput.appendChild(div);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

// Clear terminal
clearBtn.addEventListener('click', () => {
    terminalOutput.innerHTML = '';
    addToTerminal('<span class="text-gray-500">Terminal cleared</span>');
    addToTerminal('');
});

// Update command history display
function updateHistory() {
    if (commandHistory.length === 0) {
        historyContainer.innerHTML = '<div class="text-gray-500 text-xs">No commands executed yet</div>';
        return;
    }
    
    historyContainer.innerHTML = commandHistory
        .slice(-10)
        .reverse()
        .map(cmd => `<div class="text-gray-400">${escapeHtml(cmd)}</div>`)
        .join('');
}

// Handle Enter key for submit, Shift+Enter for new line
commandInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        commandForm.dispatchEvent(new Event('submit'));
    } else if (e.key === 'ArrowUp' && !e.shiftKey && commandInput.value.indexOf('\n') === -1) {
        // Only navigate history if single line mode
        e.preventDefault();
        if (historyIndex > 0) {
            historyIndex--;
            commandInput.value = commandHistory[historyIndex];
            autoResize();
        }
    } else if (e.key === 'ArrowDown' && !e.shiftKey && commandInput.value.indexOf('\n') === -1) {
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            commandInput.value = commandHistory[historyIndex];
            autoResize();
        } else {
            historyIndex = commandHistory.length;
            commandInput.value = '';
            autoResize();
        }
    }
});

// Auto-resize textarea
function autoResize() {
    commandInput.style.height = 'auto';
    commandInput.style.height = Math.min(commandInput.scrollHeight, 150) + 'px';
}
commandInput.addEventListener('input', autoResize);

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Escape HTML and preserve newlines for terminal output
function escapeHtmlPreserveNewlines(text) {
    const escaped = escapeHtml(text);
    return escaped.replace(/\n/g, '<br>');
}

// Focus input on load
commandInput.focus();
</script>
{% endblock %}
